<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>성북구 빈집 지도</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    #map { width:100%; height:70vh; }
    .controls { padding:10px; display:flex; gap:10px; align-items:center; }
    .list { padding:10px; max-height:25vh; overflow:auto; }
    .marker-item { padding:6px 0; border-bottom:1px solid #eee; }
    img.thumb { max-width:120px; display:block; margin-top:6px; }
  </style>
</head>
<body>
  <div class="controls">
    <input id="csvfile" type="file" accept=".csv" />
    <button id="downloadCsv">현재 마커 CSV로 저장</button>
    <div>지도 클릭하면 마커 추가 → 우측 목록에서 편집 가능</div>
  </div>

  <div id="map"></div>

  <div class="list" id="markerList"></div>

  <!-- Kakao Maps SDK: appkey 교체 필요 -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=APP_KEY_HERE"></script>

  <!-- PapaParse (CSV 파싱) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    // 성북구 중심 좌표(대략)
    const centerLat = 37.589, centerLng = 127.019;

    const map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(centerLat, centerLng),
      level: 5
    });

    const markers = []; // {markerObj, data:{name,lat,lng,photo_url,notes}}

    // 인포윈도우 생성 함수
    function createInfoContent(d) {
      let html = '<div style="padding:8px;max-width:240px">';
      html += `<strong>${d.name || '무명'}</strong><br/>`;
      if (d.photo_url) html += `<img src="${d.photo_url}" class="thumb" alt="photo"/><br/>`;
      if (d.notes) html += `<div style="margin-top:6px">${d.notes}</div>`;
      html += `<div style="margin-top:6px;font-size:12px;color:#666">(${d.lat}, ${d.lng})</div>`;
      html += '</div>';
      return html;
    }

    function addMarker(data, openInfo=false) {
      const pos = new kakao.maps.LatLng(parseFloat(data.lat), parseFloat(data.lng));
      const marker = new kakao.maps.Marker({ map, position: pos });
      const infowindow = new kakao.maps.InfoWindow({ content: createInfoContent(data) });

      kakao.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map, marker);
      });

      markers.push({ markerObj: marker, data, infowindow });
      renderList();
      if (openInfo) infowindow.open(map, marker);
    }

    // 마커 리스트 렌더
    function renderList() {
      const container = document.getElementById('markerList');
      container.innerHTML = '';
      markers.forEach((m, idx) => {
        const el = document.createElement('div');
        el.className = 'marker-item';
        el.innerHTML = `<strong>${m.data.name || '무명'}</strong>
                        <div style="font-size:12px;color:#555">(${m.data.lat}, ${m.data.lng})</div>
                        <div style="margin-top:6px">
                          <button data-i="${idx}" class="zoomBtn">확대</button>
                          <button data-i="${idx}" class="delBtn">삭제</button>
                        </div>`;
        container.appendChild(el);
      });

      // 이벤트 바인딩
      container.querySelectorAll('.zoomBtn').forEach(btn => {
        btn.onclick = () => {
          const i = btn.getAttribute('data-i');
          const pos = markers[i].markerObj.getPosition();
          map.setCenter(pos);
          markers[i].infowindow.open(map, markers[i].markerObj);
        };
      });
      container.querySelectorAll('.delBtn').forEach(btn => {
        btn.onclick = () => {
          const i = btn.getAttribute('data-i');
          markers[i].markerObj.setMap(null);
          markers.splice(i,1);
          renderList();
        };
      });
    }

    // CSV 업로드 처리
    document.getElementById('csvfile').addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      Papa.parse(f, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          // 기대 컬럼: name,lat,lng,photo_url,notes
          results.data.forEach(row => {
            if (row.lat && row.lng) addMarker(row);
          });
          alert('CSV 로드 완료: ' + results.data.length + '개 행(위치 존재시 마커 추가).');
        }
      });
    });

    // 지도 클릭으로 마커 추가
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
      const latlng = mouseEvent.latLng;
      const name = prompt("이 빈집의 이름/표시할 텍스트를 입력하세요 (취소 = 취소)");
      if (name === null) return;
      const notes = prompt("메모(짧게) 입력 (취소 = 빈칸)");
      const data = { name: name || '무명', lat: latlng.getLat(), lng: latlng.getLng(), photo_url: '', notes: notes || '' };
      addMarker(data, true);
    });

    // CSV로 저장 (다운로드)
    document.getElementById('downloadCsv').addEventListener('click', () => {
      if (markers.length === 0) { alert('마커가 없습니다.'); return; }
      const header = ['name','lat','lng','photo_url','notes'];
      const rows = markers.map(m => {
        return [m.data.name || '', m.data.lat, m.data.lng, m.data.photo_url || '', (m.data.notes||'').replace(/\n/g,' ')];
      });
      const csv = [header.join(',')].concat(rows.map(r => r.map(c => `"${(c+'').replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'vacant_houses.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // (옵션) 예시 데이터 자동 추가 — 나중에 지우거나 주석처리
    const example = [
      { name: '빈집 예시1', lat: 37.5891, lng: 127.0185, photo_url: '', notes:'창문깨짐' },
      { name: '빈집 예시2', lat: 37.5878, lng: 127.0202, photo_url: '', notes:'현관 잠김' }
    ];
    example.forEach(e => addMarker(e));
  </script>
</body>
</html>
